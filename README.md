# vtikh_infra
vtikh Infra repository

## ДЗ 05 - packer base

В ДЗ 05 выполняется запекание в образ ВМ необходимых зависимостей для примера приложения, после чего приложение разворачивается "классическим" способом через выполнение команд (скрипта) в ВМ. Образ билдится в Яндекс.Облаке.

### Использование

1. Установить (packer)[https://www.packer.io/]
1. Установить утилиту `yc` и подготовить окружение - создать УЗ в Яндекс.Облаке, или связать окружение с существующим аккаунтом
1. подготовить файл `packer/variables.json`, основываясь на примере
2. в корне репозитория выполнить `packer build -var-file packer/variables.json packer/ubuntu16.json`
3. после готовности образа создать на его основе ВМ и доустановить приложение в гостевой ОС в соответствии с командами скрипта `config-scripts/deploy.sh`

## ДЗ 04

Блок для автотеста:
```
testapp_IP=84.201.159.59
testapp_port=9292
```

## ДЗ 03

В разделе приводятся действия, необходимые для подтверждения выполнения домашнего задания №3.

### bastion host - стандартное задание

Для подключения к ВМ без публичного адреса, находящейся за бастион-хостом, необходимо:

1. Добавить в файл `~/.ssh/config` следующие строки:
```
Host <internal-VM-ip>
  ProxyCommand ssh <username>@<bastion_white_ip> -W %h:%p
```
где:
*internal-VM-ip* - локальный адрес целевой ВМ,  
*username* - имя пользователя на бастион-хосте,  
*bastion_white_ip* - внешний адрес бастион-хоста.

2. подключиться к целевой машине в одну команду `ssh <user>@<internal-VM-ip>`,
где *user* - имя пользователя целевой машины.

### bastion host - дополнительное задание

Для того, чтобы было возможно подключаться, указывая клиенту ssh только имя хоста целевой машины (в примере примем имя *someinternalhost*), находящейся за бастион-хостом, необходимо:

1. отредактировать файл `/etc/hosts` (или `c:\windows\system32\etc\hosts` для ОС семейства Windows). Для этого потребуются права суперпользвателя. Добавить строку:
``` <internal-VM-ip> someinternalhost```
2.  Созданную ранее секцию в файле `~/.ssh/config` привести к виду:
```
Hosts someinternalhost
  User <user>
  ProxyCommand ssh <username>@<bastion_white_ip> -W %h:%p
```
здесь *user* - имя пользователя на целевой ВМ, остальные условные обозначения описаны выше.

3. Теперь возможно подключение по команде `ssh someinternalhost`

### pritunl - стандартное задание

Согласно заданию на бастионе скриптом `setupvpn.sh` развернут VPN-сервер **pritunl**; теперь через его туннель возможен трафик на любые порты хоста во внутренней сети облака. 

Проверочный блок для ваших роботов:
```
bastion_IP=84.252.139.218
someinternalhost_IP=10.129.0.25
```

### pritunl - дополнительное задание

как обеспечить пруф валидности сертификата из командной строки не нашел :(

сертификат, полученный на хостнейм в репозитории - `cert.crt`

инстанс поживет, можно проверить валидность в браузере - [https://84-252-139-218.sslip.io/](https://84-252-139-218.sslip.io/)

